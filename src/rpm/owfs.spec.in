%define build_fs 1
%define build_httpd 1
%define build_capi 1
%define build_ownet 1
%define build_ftpd 1
%define build_server 1
%define build_perl 1
%define build_python 1
%define build_php 1
%define build_side 1
%define build_tap 1
%define build_mon 1
%define build_tcl 1
%define build_shell 1
%define build_man 1

%define debug_package   %{nil}

Name: owfs
Version: @VERSION@
Release: 1
Summary: 1-Wire Virtual File System
Source: %{name}-%{version}.tar.gz
#Copyright: GPL
License: GPL
Group: System Environment/Libraries
URL: http://sourceforge.net/projects/owfs
Buildroot: %{_tmppath}/%{name}-root
Prefix: /usr
Packager: Serg Oskin <serg@oskin.ru>
Summary: Virtual filesystem on top of %{name}-libs providing access to 1-Wire networks.

%description
OWFS is a userspace virtual filesystem providing access to 1-Wire networks.

%package libs
Summary: Core library providing base functions to other OWFS modules.
Group: System Environment/Libraries
Requires: libusb >= 0.1.6
BuildRequires: automake autoconf libtool
BuildRequires: libusb-devel

%description libs
%{name}-libs is a core library providing base functions to other OWFS modules.

%if %{build_capi}
%package capi
Summary: C-API to develop third-part applications which access 1-Wire networks.
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}

%description capi
%{name}-capi library on top of libow providing an easy API to develop third-part applications to access to 1-Wire networks.
%endif

%if %{build_ownet}
%package ownet
Summary: C-API to develop third-part applications which access 1-Wire networks.
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}

%description ownet
%{name}-ownet library provids an easy API to develop third-part applications to access to 1-Wire networks. It doesn't depend on owlib, and only supports remote-server connections. This library doesn't include any 1-wire adapter support, except server connections.
%endif

%if %{build_fs}
%package fs
Summary: Virtual filesystem on top of %{name}-libs providing access to 1-Wire networks.
Group: System Environment/Daemon
Requires: %{name}-libs = %{version}, fuse >= 1.0
#BuildRequires: fuse-devel >= 1.0

%description fs
%{name}-fs is a virtual filesystem on top of %{name}-libs providing access to 1-Wire networks.
%endif

%if %{build_httpd}
%package httpd
Summary: HTTP daemon providing access to 1-Wire networks.
Group: System Environment/Daemon
Requires: %{name}-libs = %{version}

%description httpd
%{name}-httpd is a HTTP daemon on top of %{name} providing access to 1-Wire networks.
%endif

%if %{build_ftpd}
%package ftpd
Summary: FTP daemon providing access to 1-Wire networks.
Group: System Environment/Daemon
Requires: %{name}-libs = %{version}

%description ftpd
%{name}-ftpd is a FTP daemon on top of %{name} providing access to 1-Wire networks.
%endif

%if %{build_server}
%package server
Summary: Backend server (daemon) for 1-wire control
Group: System Environment/Daemon
Requires: %{name}-libs = %{version}

%description server
%{name}-server is the backend component of the OWFS 1-wire bus control system.
owserver arbitrates access to the bus from multiple client processes. The
physical bus is usually connected to a serial or USB port, and other processes
connect to owserver over network sockets (tcp port). Communication can be local
or over a network.
%endif

%if %{build_side}
%package side
Summary: Packet sniffer for the owserver protocol
Group: System Environment/Daemon
Requires: tcl >= 8.1

%description side
%{name}-side is a packet sniffer for the owserver protocol
%endif

%if %{build_tap}
%package tap
Summary: Packet sniffer for the owserver protocol
Group: System Environment/Daemon
Requires: tcl >= 8.1

%description tap
%{name}-tap is a packet sniffer for the owserver protocol
%endif

%if %{build_mon}
%package mon
Summary: Statistics and settings monitor for owserver
Group: System Environment/Daemon
Requires: tcl >= 8.1

%description mon
%{name}-mon is a graphical monitor of owserver\'s status
%endif

%if %{build_perl}
%package perl
Summary: %{name}-perl is a Perl interface for the 1-wire filesystem
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}

%description perl
%{name}-perl is a Perl interface for the 1-wire filesystem
%endif

%if %{build_python}
%package python
Summary: %{name}-python is a python interface for the 1-wire filesystem
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}, python >= 2.0
BuildRequires: python-devel >= 2.0

%description python
%{name}-python is a Python interface for the 1-wire filesystem
%endif

%if %{build_php}
%package php
Summary: %{name}-php is a php interface for the 1-wire filesystem
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}, php >= 4.3.0
BuildRequires: php-devel >= 4.3.0

%description php
%{name}-php is a php interface for the 1-wire filesystem
%endif

%if %{build_tcl}
%package tcl
Summary: %{name}-tcl is a Tcl interface for the 1-wire filesystem
Group: System Environment/Libraries
Requires: %{name}-libs = %{version}, tcl >= 8.1
BuildRequires: tcl-devel >= 8.1

%description tcl
%{name}-tcl is a Tcl interface for the 1-wire filesystem
%endif

%if %{build_shell}
%package shell
Summary: %{name}-shell gives light weight shell access to owserver and the 1-wire filesystem
Group: Applications/System

%description shell
%{name}-shell is 4 small programs to easily access owserver (and thus the 1-wire system) from shell scripts. owdir, owread, owwrite and owpresent.
%endif

%if %{build_man}
%package man
Summary: %{name}-man installs man pages for all the OWFS programs 1-wire devices.
Group: Documentation

%description man
%{name}-man installs man pages for all the OWFS progams (owfs, owhtttpd, owserver, owftpd, owshell, owperl, owtcl) and also all the supported 1-wire devices.
%endif


%clean
rm -rf $RPM_BUILD_ROOT

%prep
%setup

%build
aclocal
libtoolize -f -c
autoheader
autoconf
automake -a -c
./configure \
	--prefix=%{prefix} \
	--libdir=%{_libdir} \
	--enable-usb \
	--enable-cache \
	--enable-mt \
%if %{build_fs}
	--enable-owfs \
%else
	--disable-owfs \
%endif
%if %{build_httpd}
	--enable-owhttpd \
%else
	--disable-owhttpd \
%endif
%if %{build_capi}
	--enable-owcapi \
%else
	--disable-owcapi \
%endif
%if %{build_ownet}
	--enable-ownetlib \
%else
	--disable-ownetlib \
%endif
%if %{build_ftpd}
	--enable-owftpd \
%else
	--disable-owftpd \
%endif
%if %{build_server}
	--enable-owserver \
%else
	--disable-owserver \
%endif
%if %{build_side}
	--enable-owside \
%else
	--disable-owside \
%endif
%if %{build_tap}
	--enable-owtap \
%else
	--disable-owtap \
%endif
%if %{build_mon}
	--enable-owmon \
%else
	--disable-owmon \
%endif
%if %{build_perl}
	--enable-owperl \
%else
	--disable-owperl \
%endif
%if %{build_python}
	--enable-owpython \
%else
	--disable-owpython \
%endif
%if %{build_php}
	--enable-owphp \
%else
	--disable-owphp \
%endif
%if %{build_tcl}
	--enable-owtcl \
%else
	--disable-owtcl \
%endif

make
#make check

%install
case "$RPM_BUILD_ROOT" in *-root) rm -rf $RPM_BUILD_ROOT ;; esac
make install \
	DESTDIR=$RPM_BUILD_ROOT

install -d -m 755 $RPM_BUILD_ROOT%{prefix}/include/owfs
mv -f $RPM_BUILD_ROOT%{prefix}/include/*.h $RPM_BUILD_ROOT%{prefix}/include/owfs

# man-files already installed at correct place on FC7
if [ -d $RPM_BUILD_ROOT%{prefix}/man ]; then
   install -d -m 755 $RPM_BUILD_ROOT%{_mandir}
   install -d -m 755 $RPM_BUILD_ROOT%{_mandir}/man1
   mv -f $RPM_BUILD_ROOT%{prefix}/man/man1/* $RPM_BUILD_ROOT%{_mandir}/man1/
   install -d -m 755 $RPM_BUILD_ROOT%{_mandir}/man3
   mv -f $RPM_BUILD_ROOT%{prefix}/man/man3/* $RPM_BUILD_ROOT%{_mandir}/man3/
   install -d -m 755 $RPM_BUILD_ROOT%{_mandir}/man5
   mv -f $RPM_BUILD_ROOT%{prefix}/man/man5/* $RPM_BUILD_ROOT%{_mandir}/man5/
   install -d -m 755 $RPM_BUILD_ROOT%{_mandir}/mann
   mv -f $RPM_BUILD_ROOT%{prefix}/man/mann/* $RPM_BUILD_ROOT%{_mandir}/mann/
   rm -rf $RPM_BUILD_ROOT%{prefix}/man
fi

%if %{build_fs}
install -D -m 644 src/rpm/owfs.conf $RPM_BUILD_ROOT/etc/sysconfig/owfs
install -D -m 755 src/rpm/owfs.init $RPM_BUILD_ROOT/etc/rc.d/init.d/owfs
install -d -m 755 $RPM_BUILD_ROOT%{prefix}/sbin
mv -f $RPM_BUILD_ROOT%{prefix}/bin/owfs $RPM_BUILD_ROOT%{prefix}/sbin
%endif
%if %{build_httpd}
install -D -m 755 src/rpm/owhttpd.conf $RPM_BUILD_ROOT/etc/sysconfig/owhttpd
install -D -m 644 src/rpm/owhttpd.init $RPM_BUILD_ROOT/etc/rc.d/init.d/owhttpd
install -d -m 755 $RPM_BUILD_ROOT%{prefix}/sbin
mv -f $RPM_BUILD_ROOT%{prefix}/bin/owhttpd $RPM_BUILD_ROOT%{prefix}/sbin
%endif
%if %{build_ftpd}
install -D -m 644 src/rpm/owftpd.conf $RPM_BUILD_ROOT/etc/sysconfig/owftpd
install -D -m 755 src/rpm/owftpd.init $RPM_BUILD_ROOT/etc/rc.d/init.d/owftpd
install -d -m 755 $RPM_BUILD_ROOT%{prefix}/sbin
mv -f $RPM_BUILD_ROOT%{prefix}/bin/owftpd $RPM_BUILD_ROOT%{prefix}/sbin
%endif
%if %{build_server}
install -D -m 644 src/rpm/owserver.conf $RPM_BUILD_ROOT/etc/sysconfig/owserver
install -D -m 755 src/rpm/owserver.init $RPM_BUILD_ROOT/etc/rc.d/init.d/owserver
install -d -m 755 $RPM_BUILD_ROOT%{prefix}/sbin
mv -f $RPM_BUILD_ROOT%{prefix}/bin/owserver $RPM_BUILD_ROOT%{prefix}/sbin
%endif
%if %{build_side}
%endif
%if %{build_tap}
%endif
%if %{build_mon}
%endif
%if %{build_perl}
%define perl_archlib %(eval "`perl -V:installarchlib`"; echo $installarchlib)
%define perl_sitearch %(eval "`perl -V:installsitearch`"; echo $installsitearch)
%define perl_sitelib %(eval "`perl -V:installsitelib`"; echo $installsitelib)
rm -f $RPM_BUILD_ROOT%{perl_archlib}/perllocal.pod
rm -f $RPM_BUILD_ROOT%{perl_sitearch}/auto/OW/.packlist
rm -f $RPM_BUILD_ROOT%{perl_sitearch}/auto/OWNet/.packlist
%endif
%if %{build_python}
# Remove OpenSUSE info files
rm -f $RPM_BUILD_ROOT@PYSITEDIR@/ow-*-info
rm -f $RPM_BUILD_ROOT@PYSITEDIR@/ownet-*-info
%endif
%if %{build_php}
rm -f $RPM_BUILD_ROOT@PHPLIBDIR@/libowphp.la $RPM_BUILD_ROOT@PHPLIBDIR@/libowphp.a
%endif
%if %{build_tcl}
rm -f $RPM_BUILD_ROOT%{_libdir}/owtcl-*/ow.la $RPM_BUILD_ROOT%{_libdir}/owtcl-*/ow.a
%endif

#mv -f $RPM_BUILD_ROOT%{prefix}/bin/* $RPM_BUILD_ROOT%{prefix}/sbin
#rm -rf $RPM_BUILD_ROOT%{prefix}/bin

%post libs
/sbin/ldconfig

%postun libs
/sbin/ldconfig

%if %{build_capi}
%post capi
/sbin/ldconfig

%postun capi
/sbin/ldconfig
%endif

%if %{build_ownet}
%post ownet
/sbin/ldconfig

%postun ownet
/sbin/ldconfig
%endif

%if %{build_fs}
%post fs
/sbin/chkconfig --add owfs

%preun fs
if [ $1 = 0 ]; then
	/sbin/chkconfig --del owfs
fi
%endif

%if %{build_httpd}
%post httpd
/sbin/chkconfig --add owhttpd

%preun httpd
if [ $1 = 0 ]; then
	/sbin/chkconfig --del owhttpd
fi
%endif

%if %{build_ftpd}
%post ftpd
/sbin/chkconfig --add owftpd

%preun ftpd
if [ $1 = 0 ]; then
	/sbin/chkconfig --del owftpd
fi
%endif

%if %{build_server}
%post server
/sbin/chkconfig --add owserver

%preun server
if [ $1 = 0 ]; then
	/sbin/chkconfig --del owserver
fi
%endif

%files libs
%defattr(-,root,root)
%doc README NEWS INSTALL ChangeLog AUTHORS COPYING
%{prefix}/include/owfs/owfs_config.h
%{_libdir}/libow-*.so*
%{_libdir}/libow.so
%{_libdir}/libow.a
%{_libdir}/libow.la
%{_mandir}/man3/*.3.gz

%if %{build_capi}
%files capi
%defattr(-,root,root)
%{prefix}/include/owfs/owcapi.h
%{_libdir}/libowcapi-*.so*
%{_libdir}/libowcapi.so
%{_libdir}/libowcapi.a
%{_libdir}/libowcapi.la
%{_mandir}/man1/*owcapi.1.gz
%endif

%if %{build_ownet}
%files ownet
%defattr(-,root,root)
%{prefix}/include/owfs/ownetapi.h
%{_libdir}/libownet-*.so*
%{_libdir}/libownet.so
%{_libdir}/libownet.a
%{_libdir}/libownet.la
#%{_mandir}/man1/*ownet.1.gz
%endif

%if %{build_fs}
%files fs
%defattr(-,root,root)
%attr(0755,root,root) /etc/rc.d/init.d/owfs
%config /etc/sysconfig/owfs
%{prefix}/sbin/owfs
%{_mandir}/man1/owfs.1.gz
%endif

%if %{build_httpd}
%files httpd
%defattr(-,root,root)
%attr(0755,root,root) /etc/rc.d/init.d/owhttpd
%config /etc/sysconfig/owhttpd
%{prefix}/sbin/owhttpd
%{_mandir}/man1/owhttpd.1.gz
%endif

%if %{build_shell}
%files shell
%defattr(-,root,root)
%{prefix}/bin/owdir
%{prefix}/bin/owread
%{prefix}/bin/owwrite
%{prefix}/bin/owpresent
%{_mandir}/man1/owshell.1.gz
%{_mandir}/man1/owdir.1.gz
%{_mandir}/man1/owread.1.gz
%{_mandir}/man1/owwrite.1.gz
%{_mandir}/man1/owpresent.1.gz

%if %{build_php}
# include ownet-php (it's a duplicate since it's in owfs-php too)
%{prefix}/bin/ownet.php
%endif

%if %{build_python}
#%dir @PYSITEDIR@/ow
#@PYSITEDIR@/ow/__init__.py*
#@PYSITEDIR@/ow/_OW.so
# include ownet-python (it's a duplicate since it's in owfs-python too)
%dir @PYSITEDIR@/ownet
@PYSITEDIR@/ownet/__init__.py*
@PYSITEDIR@/ownet/connection.py*
%endif

%endif

%if %{build_man}
%files man
%defattr(-,root,root)
%{_mandir}/man1/ow*.1.gz
%{_mandir}/man3/*.3.gz
%{_mandir}/man5/*.5.gz
%{_mandir}/mann/*.n.gz
%endif

%if %{build_ftpd}
%files ftpd
%defattr(-,root,root)
%attr(0755,root,root) /etc/rc.d/init.d/owftpd
%config /etc/sysconfig/owftpd
%{prefix}/sbin/owftpd
%{_mandir}/man1/owftpd.1.gz
%endif

%if %{build_server}
%files server
%defattr(-,root,root)
%attr(0755,root,root) /etc/rc.d/init.d/owserver
%config /etc/sysconfig/owserver
%{prefix}/sbin/owserver
%{_mandir}/man1/owserver.1.gz
%endif

%if %{build_side}
%files side
%defattr(-,root,root)
%{prefix}/bin/owside
#%{_mandir}/man1/owside.1.gz
%endif

%if %{build_tap}
%files tap
%defattr(-,root,root)
%{prefix}/bin/owtap
%{_mandir}/man1/owtap.1.gz
%endif

%if %{build_mon}
%files mon
%defattr(-,root,root)
%{prefix}/bin/owmon
#%{_mandir}/man1/owmon.1.gz
%endif

%if %{build_perl}
%files perl
%defattr(-,root,root)
%dir %{perl_sitearch}/auto/OW
%{perl_sitearch}/auto/OW/OW.bs
%{perl_sitearch}/auto/OW/OW.so
%{perl_sitearch}/OW.pm
%{perl_sitelib}/OWNet.pm
%{_mandir}/man3/OWNet.3pm.gz
%endif

%if %{build_python}
%files python
%defattr(-,root,root)
%dir @PYSITEDIR@/ow
@PYSITEDIR@/ow/__init__.py*
@PYSITEDIR@/ow/_OW.so
#OpenSUSE info file
#@PYSITEDIR@/ow-*info
%dir @PYSITEDIR@/ownet
@PYSITEDIR@/ownet/__init__.py*
@PYSITEDIR@/ownet/connection.py*
#OpenSUSE info file
#@PYSITEDIR@/ownet-*info
%endif

%if %{build_php}
%files php
%defattr(-,root,root)
%dir @PHPLIBDIR@
@PHPLIBDIR@/libowphp.so*
%{prefix}/bin/ownet.php
%endif

%if %{build_tcl}
%files tcl
%defattr(-,root,root)
%dir %{_libdir}/owtcl-*
%{_libdir}/owtcl-*/ow-*.so
%{_libdir}/owtcl-*/ow.so
%{_libdir}/owtcl-*/ow.tcl
%{_libdir}/owtcl-*/pkgIndex.tcl
%{_mandir}/mann/owtcl.n.gz
%endif


%changelog

* Tue Jan 19 2008 Christian Magnusson <mag@mag.cx>
- x86_64 support, tested on i386 and x86_64

* Tue Jan 15 2008 Serg Oskin <serg@oskin.ru>
- no scripts for owshell
- x86_64 support (Not fully tested)

* Sat Sep 30 2006 Paul Alfille <paul.alfille@gmail.com>
- added shell programs, removed nfsd

* Thu Jan 13 2005 Serg Oskin <oskin@macomnet.ru>
- reorganized

* Sun Oct 24 2004 Serg Oskin <oskin@macomnet.ru>
- recreated

* Wed Sep 24 2003 Vadim Tkachenko <vt@freehold.crocodile.org>
- Initial take at RPM build
