#!/bin/bash
#
# owhttpd        Startup script for the 1-Wire networks
#
# chkconfig: - 95 05
# description: OWHTTPD is a HTTP daemon providing access to 1-Wire networks.
#
# config: /etc/sysconfig/owhttpd

# Source function library.
. /etc/rc.d/init.d/functions

if [ -f /etc/sysconfig/owhttpd ]; then
        . /etc/sysconfig/owhttpd
fi

numfs=${#PORT[*]}
if [ $numfs -eq 0 ]; then
	exit 0
fi

lockfile=/var/lock/subsys/owhttpd
owhttpd=/usr/sbin/owhttpd
RETVAL=0

start() {
        echo -n $"Starting owhttpd: "
	i=0; n=0
	while [ $n -lt $numfs ]; do
		port=${PORT[$i]}
		interface=${INTERFACE[$i]}
		options=${OPTIONS[$i]}
		if [ "$port" != "" ]; then
			if [ "$interface" != "" ]; then
				case $interface in
				[uU][sS][bB][0-9]*)
					/sbin/modprobe -rq ds9490r
					$owhttpd -u`echo $interface | sed -e 's/usb//i'` -p $port $options >/dev/null
					;;
				[uU][sS][bB])
					/sbin/modprobe -rq ds9490r
					$owhttpd -u -p $port $options >/dev/null
					;;
				/*)
					$owhttpd -d $interface -p $port $options >/dev/null
					;;
				[sS][oO][cC][kK][eE][tT]:*)
					socket=`echo $interface | sed -e 's/^socket://i'`
					$owhttpd -s $socket -p $port $options >/dev/null
					;;
				*:*)
					$owhttpd -s $interface -p $port $options >/dev/null
					;;
				*)
					echo "ERROR: Bad interface \"$interface\""
					/bin/false
					;;
				esac
				RETVAL=$?
				[ $RETVAL = 0 ] || {
					echo_failure
					echo
					return $RETVAL
				}
			fi
			n=`expr $n + 1`
		fi
		i=`expr $i + 1`
	done
	echo_success
	echo
	touch ${lockfile}
	return 0
}

stop() {
	echo -n $"Shutdown owhttpd: "
	killproc $owhttpd
	RETVAL=$?
	echo
	[ $RETVAL = 0 ] && rm -f ${lockfile}
}

# See how we were called.
case "$1" in
  start)
	start
	;;
  stop)
	stop
	;;
  status)
	status $owhttpd
	;;
  restart)
	stop
	start
	;;
  condrestart)
	if /sbin/pidof $owhttpd >/dev/null ; then
		stop
		start
	fi
	;;
  *)
	echo $"Usage: $prog {start|stop|restart|condrestart|status}"
	exit 1
esac

exit $RETVAL
